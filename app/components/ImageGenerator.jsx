import React, { useState, useEffect } from "react";
import { generateImage } from "../utils/illustroke";
import {
  collection,
  addDoc,
  getDocs,
  QuerySnapshot,
  query,
  onSnapshot,
} from "firebase/firestore";
import { db } from "../firebase/initFirebase";

const ImageGenerator = () => {
  const [prompt, setPrompt] = useState("");
  const [imageUrl, setImageUrl] = useState("");
  const [loading, setLoading] = useState(false);

  const handleSubmit = async (e) => {
    e.preventDefault();
    setLoading(true);
    try {
      const data = await generateImage(
        "flat",
        "a pink rose",
        "full",
        "color",
        1
      );
      const respText = await data.text();
      console.log(respText);

      const svgString = respText.match(/<svg.*<\/svg>/);

      const cleanedSvgStr = svgString[0].replace(/\\/g, "");

      const svgData = cleanedSvgStr;

      const blob = new Blob([svgData], { type: "image/svg+xml" });

      const url = URL.createObjectURL(blob);

      setImageUrl(url);

      console.log(url);

      await addDoc(collection(db, "testData"), {
        img_url: url,
      });

      return () => URL.revokeObjectURL(url);
    } catch (error) {
      console.error("Error generating image:", error);
    } finally {
      setLoading(false);
    }
  };

  const svgData2 =
    '<?xml version="1.0" ?><svg xmlns="http://www.w3.org/2000/svg" width="512" height="512"> <path fill="#a1928f" d="M0 0h512v512H0V0Z" /> <path fill="#fdfdfd" d="M328 137c1.62 10.253 2.216 20.387 2.25 30.75l.027 3.366c-.034 9.608-.687 18.909-4.277 27.884a320.827 320.827 0 0 0-1.813 7.313c-1.74 7.12-3.796 14.088-6.039 21.066L317 231l-1.125 3.535C313.485 244 314.357 252.428 319 261c1.175 2.308 2.34 4.621 3.5 6.938l1.719 3.34c4.094 8.555 6.903 17.22 9.344 26.347 4.299 15.976 9.818 28.755 20.656 41.43 7.624 10.815 9.623 19.947 9.469 33.07-.612 18.122-.612 18.122 8.312 32.875l5 .5c5.929.593 7.12 1.392 10 6.5 1 4.25 1 4.25 1 8-5.235 3.49-12.37 1.98-18.527 1.746-2.825-.058-5.653.082-8.473.254l-1 4c-4.172.426-4.172.426-9.75.313l-5.992-.106A1022.16 1022.16 0 0 1 317 425c0-3.564 3.645-4.787 6.375-6.688l3.863-2.726a230.788 230.788 0 0 1 6.742-4.484c8.085-5.21 12.49-11.389 13.02-21.102l.375-3.563c-.462-5.471-2.19-9.96-4.129-15.07-1.382-3.734-2.39-7.48-3.246-11.367l-1.188 5.063c-5.83 22.922-21.447 59.579-45.671 69.055-9.525 2.674-19.205 3.198-29.047 3.218l-3.54.02c-2.444.01-4.888.015-7.331.015-3.742.004-7.482.04-11.223.078-2.385.006-4.77.01-7.156.012l-3.378.043c-9.92-.058-9.92-.058-13.466-4.504l-.938-4.938c-1.257-5.991-2.104-6.728-7.062-10.062-31.653-22.533-44.66-45.33-42-84 1.393-11.12 3.455-22.716 8-33h2c.661 2.602 1.196 5.236 1.688 7.875a407.067 407.067 0 0 0 5.75 24.563l.836 3.224c1.992 7.402 4.648 14.324 7.726 21.338.836 1.978 1.67 3.957 2.5 5.938l1.258 2.996c1.282 3.164 2.447 6.359 3.617 9.566 2.502 6.611 5.885 12.518 9.625 18.5 4.727-11.098 4.108-22.44 3.992-34.277l-.05-9.623c-.031-5.01-.067-10.018-.113-15.027-.205-23.294.179-43.963 8.171-66.073 1.023-3.18 1.998-6.37 2.953-9.57.76-2.488 1.568-4.96 2.406-7.422 9.957-30.486-4.927-47.869-23.922-70.196-4.66-7.29-2.216-14.708-.437-22.812l2-2a232.23 232.23 0 0 0 2.563-9c2.356-8.837 2.356-8.837 3.437-11 5 1 5 1 8.004 2.52 5.627 2.084 10.978 2.049 16.934 2.167l3.517.104c2.848.082 5.697.147 8.545.209v2c6.076-.51 6.076-.51 11.938-2.063C266.942 141.1 272.41 141.206 278 144c4.298.198 8.515.284 12.813.25l3.686-.023C305.782 144.093 319.231 137 328 137Z" /> <path fill="#523e41" d="m203 162-.281 3.367c-.537 11.067.617 15.884 8.281 23.633 20.1 24.26 26.587 40.247 16 71-1.064 3.166-2.126 6.333-3.188 9.5l-1.496 4.453c-5.07 15.59-6.623 30.708-6.476 47.031l.016 4.779c.017 4.995.048 9.991.082 14.987.027 5.01.052 10.02.07 15.03.013 3.106.03 6.21.054 9.316.052 11.173.037 20.707-5.062 30.904-5.295-7.06-8.704-14.482-11.758-22.695a234.058 234.058 0 0 0-3.617-8.993A6942.97 6942.97 0 0 1 193 358l-1.66-3.945C184.696 337.73 178 318.72 178 301h-2l-.379 2.555c-.87 4.829-2.251 9.484-3.586 14.203-2.48 10.164-3.376 19.757-3.347 30.18l-.05 3.552c-.016 29.803 17.624 49.47 41.362 65.51 6.834 4.731 7.888 7.695 8 16-5.48-.567-9.805-2.572-14.75-4.938l-4.547-2.152c-5.523-2.849-5.523-2.849-6.266-7.223-2.428-6.228-7.386-8.095-13.757-9.332a381.976 381.976 0 0 0-7.196-.902c-10.736-1.396-21.467-5.446-31.484-9.453 3.795 5.416 3.795 5.416 8.5 10 3.483 2.787 8.5 7.303 8.5 12h-2l-1 3c-6.873-.436-6.873-.436-10-2-33.043-2.045-72.99 7.99-97 32h-2l-2 4-2 4c-.667 5.89.406 9.294 4 14 10.312 7.098 19.604 8.524 31.814 9.416 7.574.791 7.574.791 10.494 4.574 2.017 4.78 2.093 8.278 1.942 13.447l-.11 4.872L89 512c-6.166.265-12.33.422-18.5.563l-5.23.228c-19.659.334-33.818-9.075-45.77-24.229-7.316-13.351-7.47-27.433.266-40.558C30.938 432.147 45.69 422.759 64 417c1.961-.742 3.92-1.492 5.875-2.25 4.534-1.548 8.396-2.26 13.125-2.75l5-2c2.997-.36 5.997-.695 9-1l2-1c2.066-.28 4.14-.512 6.215-.719l3.767-.386 3.956-.395c2.571-.257 5.143-.518 7.714-.781l3.469-.346c2.943-.288 2.943-.288 5.879-1.373l-1.793-3.297c-11.638-21.642-17.37-41.219-17.457-65.89l-.063-4.37c-.031-8.753.92-16.035 3.313-24.443a667.821 667.821 0 0 0 1.813-10.625c1.824-10.213 4.563-19.668 8.187-29.375l1.66-4.52C134.666 237.622 170.637 162 203 162Z" /> <path fill="#f3cabb" d="m305 288 5 1.875c4.188 1.78 7.403 3.407 11 6.125l3.438 2.563c13.311 12.844 14.53 29.312 15.25 46.875l.181 3.564c.274 6.71-.038 12.467-1.869 18.998l-.93 3.371C330.538 392.562 313.653 428.362 290 435c-8.612 1.797-17.13 2.318-25.906 2.336l-3.54.02c-2.444.01-4.888.015-7.331.015-3.742.004-7.482.04-11.223.078-2.385.006-4.77.01-7.156.012l-3.378.043c-9.6-.056-9.6-.056-13.466-4.504-1-2-1-2-1-8 2.195-1.898 2.195-1.898 5.125-3.375l2.883-1.523C228 419 228 419 234 419l-.805-2.781c-1.837-6.384-3.633-12.76-5.195-19.219l-1.438-5.188c-7.488-30.487-9.187-61.471 13.883-85.417 15.963-14.962 42.926-26.9 64.555-18.395Z" /> <path fill="#5c5360" d="M214 25c2.292 1.823 2.292 1.823 4.617 4.191l2.59 2.616 2.668 2.756 2.645 2.673c12.451 12.667 12.451 12.667 16.855 19.389 3.977 3.598 6.553 1.553 11.625.375 13.022-.656 25.35-.163 38 3l2-3h2l2-4c24.411-27 24.411-27 33-27 .502 10.788-.216 21.106-1.875 31.75l-.526 3.388c-.84 5.122-1.821 9.984-3.599 14.862l-.5 3.688C325 83 325 83 323 86c.271 3.53.902 6.681 1.945 10.063 1.304 4.866 1.996 9.695 2.68 14.687.26 1.851.52 3.702.79 5.61 2.001 19.273 2.001 19.273-5.145 24.722-9.312 5.462-21.961 4.11-32.457 4.168l-3.62.028c-8.7-.032-8.7-.032-13.193-2.278-5.954-.305-10.421.1-16 2-2.999.077-6.001.09-9 0v-2l-4.977.246c-15.178.523-26.712.065-38.023-11.246-3.026-12.104-.985-28.522 6-39 .232-11.957-1.286-23.667-3.3-35.422-1.096-7.172-1.464-14.333-1.7-21.578l-.125-3.469c-.052-2.51.02-5.022.125-7.531 2-1 2-1 7 0Z" /> <path fill="#15120d" d="M125.137 405.625c5.552-.31 8.201-.175 12.55 3.438 2.178 3.707 3.23 6.816 4.313 10.937l-3.785.262C106.785 422.798 70.089 430.912 47 454h-2l-2 4-2 4c-.667 5.89.406 9.294 4 14 10.312 7.098 19.604 8.524 31.814 9.416 7.574.791 7.574.791 10.494 4.574 2.017 4.78 2.093 8.278 1.942 13.447l-.11 4.872L89 512c-6.166.265-12.33.422-18.5.563l-5.23.228c-19.659.334-33.818-9.075-45.77-24.229-7.316-13.351-7.47-27.433.266-40.558C30.938 432.147 45.69 422.759 64 417c1.961-.742 3.92-1.492 5.875-2.25 4.534-1.548 8.396-2.26 13.125-2.75l5-2c2.997-.36 5.997-.695 9-1l2-1c8.694-1.022 17.42-1.585 26.137-2.375Z" /> <path fill="#523e41" d="M331 160c4.022 4.022 4.664 10.587 6.146 15.951a564.776 564.776 0 0 0 1.853 6.457c6.865 23.452 10.926 46.933 14.274 71.092.687 4.254 1.655 8.33 2.727 12.5.364 2.01.7 4.026 1 6.047l.5 3.312.5 3.391 1 6.672.497 3.32a560.53 560.53 0 0 0 1.558 9.445c3.287 20.214 3.197 40.4 2.945 60.813-2.211-3.317-3.746-6.701-5.438-10.313-3.615-7.33-7.97-13.335-13.14-19.632-8.254-10.411-10.938-24.132-14.373-36.701-3.094-11.084-7.706-20.74-13.244-30.803-8.963-17.634-.82-35.809 5.132-53.203 1.393-4.387 2.235-8.825 3.063-13.348l.998-2.844c1.082-3.407 1.507-6.53 1.854-10.086l.39-3.906.383-4.039.406-4.11c.33-3.337.652-6.676.969-10.015Z" /> <path fill="#d4b0ab" d="M176 301h2c.661 2.602 1.196 5.236 1.688 7.875a407.067 407.067 0 0 0 5.75 24.563l.836 3.224c1.992 7.402 4.648 14.324 7.726 21.338.836 1.978 1.67 3.957 2.5 5.938l1.258 2.996c1.282 3.164 2.447 6.359 3.617 9.566 2.171 5.757 5 10.837 8.27 16.04 2.008 3.645 1.367 5.413.355 9.46.74 2.9 1.587 5.774 2.5 8.625 2.606 8.164 2.606 8.164 1.5 10.375-33.252-23.857-48.841-45.69-46-87 1.393-11.12 3.455-22.716 8-33Z" /> <path fill="#fdfdfd" d="M268 68c8.01 4.005 7.86 16.026 8.672 24.305l.332 3.318c.201 2.166.375 4.335.518 6.506.744 8.23 3.114 11.94 8.478 17.871 5.615 6.479 5.027 13.893 3 22-9.406 2.351-9.406 2.351-13.875-1.438L273 138l-1-1c-.667-6.562.345-9.345 5-14h-14l2 4c1.383 4.15 1.302 7.653 1 12-4.685 3.513-6.295 3.691-12 3-4.328-2.99-6.689-4.823-7.438-10.063.614-5.522 3.158-8.504 6.438-12.937l3.25-4.563C259 111 259 111 261 111l.148-4.313.227-5.687c.07-1.856.14-3.713.21-5.625.368-4.762 1.094-8.807 2.415-13.375l1.07-3.844 1.055-3.656 1.07-3.719L268 68Z" /> <path fill="#fdfdfd" d="M326 138c1 3 1 3-1 6-5.418 5.418-11.87 6.53-19.102 8.254-3.089.74-3.089.74-6.71 2.184-18.714 6.982-37.582 9.275-56.754 3.003-4.876-1.585-9.784-2.903-14.746-4.191l-4.739-1.234c-2.647-.681-5.297-1.353-7.949-2.016 1-4 1-4 4.777-5.738 6.098-1.473 11.55-1.596 17.786-1.45l3.345.042c2.698.035 5.395.088 8.092.146v2c6.076-.51 6.076-.51 11.938-2.063C266.942 141.1 272.41 141.206 278 144c4.298.198 8.516.284 12.813.25l3.684-.02c16.68.242 16.68.242 31.503-6.23Z" /> <path fill="#d4b0ab" d="M295 378c4.28 4.505 4.71 6.918 3 13-10.037 10.504-24.802 11.555-38.438 9.25-7.335-2.574-13.479-6.918-15.437-14.75 1.676-6.703 8.064-8.793 14.078-11.14 12.504-3.544 25.477-2.728 36.797 3.64Z" /> <path fill="#523e41" d="M339 359c3.761 1.88 3.975 7.153 5.063 10.938 1.608 6.164 1.608 6.164 3.937 12.062.621 11.799-2.05 21.655-11.938 28.875L331 414a908.247 908.247 0 0 0-7.375 5.5c-9.11 6.698-17.554 11.612-28.625 14.5 2.358-2.38 4.717-4.74 7.184-7.008 16.179-15.198 27.365-33.9 33.816-54.992l1.098-3.2c1.046-3.246 1.496-6.42 1.902-9.8Z" /> <path fill="#b4517c" d="M208 27c4.67 2.335 6.708 4.888 10.063 8.875 4.204 4.946 8.448 9.814 12.875 14.563C242 62.438 242 62.438 242 67c-3.148 2.2-3.148 2.2-7.375 4.688-5.092 3.074-9.91 6.15-14.5 9.937C216 85 216 85 214 85l-.228-2.544c-1.966-21.887-1.966-21.887-5.221-43.608-.573-4-.646-7.813-.551-11.848Z" /> <path fill="#b4517c" d="M331 32c.213 7.091-.587 13.787-1.813 20.75l-.552 3.205C324.843 77.595 324.843 77.595 321 84c-5.223-2.09-9.05-4.679-13.625-7.938l-4.54-3.214C299 70 299 70 296 67c1-4 1-4 5-6l2-4a281.95 281.95 0 0 1 8-8.25l2.234-2.258C318.747 41 318.747 41 321 41l2-4c5.455-5 5.455-5 8-5Z" /> <path fill="#e0dfe0" d="M348 384h1c2.012 6.066 2.673 12.053 3.34 18.379 1.25 6.862 3.598 10.21 9.66 13.621 3.608 1.203 6.572 1.132 10.375 1.125l3.96.008c3.915-.044 3.915-.044 8.665-1.133l2-4c.688 3.875.688 3.875 1 8-5.235 3.49-12.37 1.98-18.527 1.746-2.825-.058-5.653.082-8.473.254l-1 4c-4.172.426-4.172.426-9.75.313l-5.992-.106A1022.16 1022.16 0 0 1 317 425c0-3.564 3.645-4.787 6.375-6.688l3.863-2.726a230.788 230.788 0 0 1 6.742-4.484C344.757 404.156 346.607 396.03 348 384Z" /> <path fill="#fdfdfd" d="M139 398c12.06 3.573 12.06 3.573 16.438 5.563 7.621 3.075 15.888 4.222 24 5.312 5.616 1.136 10.828 2.657 13.562 8.125.353 6.47.353 6.47-2 10-2.785.258-2.785.258-6.063.125-5.473-.83-5.473-.83-6.937.875-14.368.632-14.368.632-19-4l-1 3-5-2 2-4h2c-2.65-4.22-5.447-7.526-9-11a506.487 506.487 0 0 1-4.813-5.188l-2.394-2.605C139 400 139 400 139 398Z" /> <path fill="#f3cabb" d="M87 488c2.98.088 5.959.196 8.938.313l5.027.175c7.336.746 12.505 1.472 17.035 7.512.974 12.1.974 12.1-4 16-4.394.366-8.376.47-12.75.313l-3.559-.069A686.98 686.98 0 0 1 89 512l-.184-3.727-.254-4.898c-.08-1.601-.162-3.202-.246-4.852-.25-3.588-.637-6.997-1.316-10.523Z" /> <path fill="#fdfdfd" d="m236.875 420.688 3.68-.114c4.06.502 5.667 1.46 8.445 4.426.881 6.265.622 7.378-4 12-5.027.531-5.027.531-10.938.5l-5.902.031c-7.264-.748-7.264-.748-10.16-4.531 1.29-6.451 3.666-7.444 9-11 3.436-1.145 6.254-1.24 9.875-1.313Z" /> <path fill="#b4517c" d="M247 130a102.603 102.603 0 0 1 2 7c3.91 4.486 7.245 4.464 13 4l3-1c2.673.28 5.341.608 8 1v1l-3.027.402-3.91.536-3.903.527c-3.015.197-3.015.197-4.16 1.535-3 .041-6 .042-9 0v-2h-25v-1l8-1v-2c-3.607-1.803-6.084-2.466-10-3 1-3 1-3 5-4.125 6.748-1.18 13.144-1.875 20-1.875Z" /> <path fill="#523e41" d="M214 25c2.292 1.823 2.292 1.823 4.617 4.191l2.59 2.616 2.668 2.756 2.645 2.673C249 60.106 249 60.106 249 65c-2.645.887-2.645.887-6 1-2.824-2.543-2.824-2.543-5.688-6.188l-3.156-3.906L231 52a457.294 457.294 0 0 0-5.688-6.188C211.686 31.06 211.686 31.06 210 26l-2-1c1-1 1-1 6 0Z" /> <path fill="#523e41" d="M331 27c-1.297 6.484-3.983 7.868-9 12a374.052 374.052 0 0 0-5 5l-15 15-2.781 2.906C297 64 297 64 294 65l-2-1c1-4 1-4 3-7h2l2-4c23.532-26 23.532-26 32-26Z" /> <path fill="#a1928f" d="M300 96c.637 4.297.471 6.285-1.938 9.938-4.268 2.874-7.024 2.772-12.062 2.062-3.983-3.4-4-4.618-4-10 5.062-5.207 12.503-7.497 18-2Z" /> <path fill="#a1928f" d="M248 92c6.853 4.112 6.123 5.366 6 13h2v2c-12.823.937-12.823.937-17.375-2.688C237 101 237 101 237 96c4.462-4.462 5.063-4.73 11-4Z" /> <path fill="#15120d" d="M263 122c4.95-.257 9.183-.204 14 1-2 4-2 4-4 6-.343 5.228.02 8.05 2 13l-10-1 .188-5.188c.28-5.952.28-5.952-3.188-10.812l1-3Z" /> <path fill="#e0dfe0" d="M247 128c11.75-.25 11.75-.25 14 2 .583 6.417.583 6.417-3 10l4 2c-6.562.566-9.38-.267-14-5-1.478-2.957-1.06-5.742-1-9Z" /> <path fill="#a1928f" d="M348 384h1c1.85 5.427 2.544 10.748 3.125 16.438l.508 4.87L353 409h-15l2.875-3.75c3.776-5.136 5.38-8.785 6.25-15l.508-3.547L348 384Z" /> <path fill="#b4517c" d="m207 25 3 2h-2l.427 2.94C216.184 83.632 216.184 83.632 213 90l-.586-4.54-.789-6.085-.414-3.202a683.583 683.583 0 0 0-2.336-16.548C207.212 48.161 206.837 36.571 207 25Z" /> <path fill="#523e41" d="M174 301h1c0 5.047-.32 7.584-1.75 12.188-3.288 11.695-4.61 23.798-6.25 35.812h-1c-.027-3.688-.047-7.375-.063-11.063l-.025-3.146c-.028-8.829.797-15.625 4.088-23.791l2.125-5.5L174 301Z" /> <path fill="#f3cabb" d="m248 422-1 2-3-2c-3.227-.357-3.227-.357-6.813-.313l-3.644-.05c-6.886.706-11.764 4.584-16.543 9.363 0-6 0-6 2.195-7.863l2.93-1.45 2.883-1.488c7.403-2.967 17.23-4.73 22.992 1.801Z" /> <path fill="#b4517c" d="M300 127h2c1.072 5.04 2.01 12.99-2 17-3.61.32-7.194.563-10.813.75l-3.064.207c-7.654.395-7.654.395-12.123-2.957h4c2.815-.03 2.815-.03 5.688-.063 5.168-.006 10.184.38 15.312 1.063l1-16Z" /> <path fill="#a1928f" d="m274.688 377.938 3.574.027L281 378v4c-3.238 1.619-6.545 1.09-10.125 1.063l-4.445-.028L263 383c2.926-5.851 5.612-5.123 11.688-5.063Z" /> <path fill="#b4517c" d="M330 26h2c.504 10.827-.223 21.19-1.875 31.875l-.526 3.439c-.754 4.622-1.492 8.473-3.599 12.686-1.472-5.674-.353-10.276.875-15.938 1.817-8.48 3.264-16.315 3.188-25l-.028-4.027L330 26Z" /> <path fill="#f3cabb" d="M288 95v9h5l-2 1v2l4 1c-8.286.61-8.286.61-11.563-2.188C282 103 282 103 282 98c3-3 3-3 6-3Z" /> <path fill="#523e41" d="M263 122c4.95-.257 9.183-.204 14 1-2 4-2 4-4 6-.4 2.323-.74 4.657-1 7h-1v-10c-4.202.574-4.202.574-6 4-3-5-3-5-2-8Z" /> </svg>';
  /*useEffect(() => {
    const blob = new Blob([svgData2], { type: "image/svg+xml" });
    const url = URL.createObjectURL(blob);
    setImageUrl(url);
    return () => URL.revokeObjectURL(url);
  }, []);
*/
  return (
    <div className="text-center">
      <form onSubmit={handleSubmit}>
        <input
          type="text"
          value={prompt}
          onChange={(e) => setPrompt(e.target.value)}
          placeholder="Enter a prompt"
          className="border border-indigo-700"
        />
        <button type="submit">Generate Image</button>
      </form>
      {/*
      <div className="fixed top-1/2 right-1/2">
        {fetchData && <a href={fetchData}>{fetchData}</a>}
      </div>
  */}
      {loading && <p>Loading...</p>}

      {imageUrl && (
        <div>
          <img
            src={imageUrl}
            alt="SVG Image"
            width="100"
            height="100"
            className="fixed inset-x-1/3 bottom-10"
          />
          <p>
            Image URL: <a href={imageUrl}>{imageUrl}</a>
          </p>
        </div>
      )}
    </div>
  );
};

export default ImageGenerator;
